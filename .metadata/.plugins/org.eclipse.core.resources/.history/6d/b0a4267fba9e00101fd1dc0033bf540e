<%@page import="de.uniwue.apps.jm1.User"%>
<%@page import="de.uniwue.apps.jm1.Item"%>
<%@page import="de.uniwue.apps.jm1.Main"%>
<%@page import="de.uniwue.apps.jm1.Buchung"%>
<%@page import="java.text.DecimalFormat"%>
<%@page import="java.text.SimpleDateFormat"%>
<%
User user = (User) session.getAttribute("user");
if (user == null) {
    response.sendRedirect("benutzer.jsp");
    return;
}
user = User.getUserbyUID("" + user.getUid());
session.setAttribute("user", user);

// Pagination Parameter
int currentPage = 1;
int itemsPerPage = 10;
try {
    String pageParam = request.getParameter("page");
    if (pageParam != null) {
        currentPage = Integer.parseInt(pageParam);
        if (currentPage < 1) currentPage = 1;
    }
} catch (NumberFormatException e) {
    currentPage = 1;
}

// Formatierungen
DecimalFormat euroFormat = new DecimalFormat("#,##0.00 €");
SimpleDateFormat dateFormat = new SimpleDateFormat("dd.MM.yyyy HH:mm");
String guthaben = euroFormat.format(user.getGuthaben() / 100.0);
%>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Verlauf - WueKaStL</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-3.7.1.min.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="user-info-header">
            <div class="user-name-header"><%= user.getVorname() %> <%= user.getNachname() %></div>
            <div class="saldo"><%= guthaben %></div>
        </div>
        
         <a class="logo" href="index.jsp" >WueKaStL</a>
        
        <a href="index.jsp" class="btn  btn-danger" >zur Startseite</a>
    </div>

    <!-- Hauptbereich -->
    
    <div class="main">
        <div class="verlauf-section">
                    <div class="verlauf-table-container">
                        <table class="verlauf-table">
                            <caption>Transaktionsverlauf</caption>
                            <thead>
                                <tr>
                                    <th>Datum</th>
									<th>#</th>
                                    <th>Summe</th>
                                    <th>Kommentar</th>
                                    <th>Inhalt</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
    								<% 
    									java.util.List<Buchung> alleBuchungen = Buchung.getBuLi(user);
    									alleBuchungen.sort((b1, b2) -> b2.getDatum().compareTo(b1.getDatum()));
    									
    									// Pagination Berechnung
    									int totalItems = alleBuchungen.size();
    									int totalPages = (int) Math.ceil((double) totalItems / itemsPerPage);
    									int startIndex = (currentPage - 1) * itemsPerPage;
    									int endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    									
    									// Nur die Buchungen für die aktuelle Seite
    									java.util.List<Buchung> buchungen = alleBuchungen.subList(startIndex, endIndex);
    							    	
    								    java.util.Date jetzt = new java.util.Date(); 
    								    long zweiTageMillis = 2L * 24 * 60 * 60 * 1000; // 2 Tage in Millisekunden
								
    								    for(Buchung buchung : buchungen) {
    								        String betrag = euroFormat.format(buchung.getSumme() / 100.0);
    								        String itemlist = Buchung.itemlistToString(buchung);
    								        String datum = dateFormat.format(buchung.getDatum());
    								        String buchungstyp = buchung.getBt().toString().toLowerCase();
								
    								        boolean istNeuGenug = (jetzt.getTime() - buchung.getDatum().getTime()) <= zweiTageMillis;
   								 %>
    								    <tr class="<%= buchungstyp  %>">
    								        <td><%= datum %></td>
    								        <td><%= buchung.getUid() %></td>
    								        <td class="betrag"><%= betrag %></td>
    								        <td><%= buchung.getKommentar() != null ? buchung.getKommentar() : "-" %></td>
    								        <td><%= itemlist != null && !itemlist.trim().isEmpty() ? itemlist : "-" %></td>
    								        
    								        <% if(buchungstyp.equals("striche") && istNeuGenug) { %>
    								            <td>
   								 								                <form action="buchungen" method="post">
    								                    <input type="hidden" name="<%=Main.USER_UID_PARAM%>" value="<%=user.getUid()%>">
    								                    <input type="hidden" name="buchungID" value="<%= buchung.getUid() %>">
    								                    <button type="submit" name="method" value="bearbeitenBuchung" class="btn btn-edit">Bearbeiten</button>
    								                </form>
    								            </td>
    								        <% } else { %>
    								            <td>-</td>
    								        <% } %>

    								        <td>
                								<% if(istNeuGenug && buchungstyp.equals("striche")) { %>
    								                <form action="buchungen" method="post">
    								                    <input type="hidden" name="<%=Main.USER_UID_PARAM%>" value="<%=user.getUid()%>">
    								                    <input type="hidden" name="buchungID" value="<%= buchung.getUid() %>">
    								                    <button type="submit" name="method" value="loescheBuchung" class="btn btn-danger">Löschen</button>
    								                </form>
    								            <% } else { %>
    								                -
    								            <% } %>
    								        </td>
    								    </tr>
    								<% } %>
								</tbody>

                        </table>
                    </div>
                    
                  
                </div>
    </div>

    <!-- Footer -->
    <div class="footer">
    	<!-- Pagination Navigation -->
                    <% if (totalPages > 1) { %>
                    <div class="pagination">
                        
                        <div class="pagination-controls">
                            <!-- Vorherige Seite -->
                            <% if (currentPage > 1) { %>
                                <a href="verlauf.jsp?page=<%= currentPage - 1 %>" class="btn btn-auswahl">← Vorherige</a>
                            <% } else { %>
                            	<a href="verlauf.jsp?page=<%= currentPage - 1 %>" class="btn btn-auswahl" disabled >← Vorherige</a>
							<% } %>
                            <!-- Seitenzahlen -->
                            <div class="page-numbers">
                                <% 
                                int startPage = Math.max(1, currentPage - 1);
                                int endPage = Math.min(totalPages, currentPage + 1);
                                
                                // Erste Seite falls nicht sichtbar
                                if (startPage > 1) { %>
                                    <a href="verlauf.jsp?page=1" class="page-number">1</a>
                                    <% if (startPage > 2) { %>
                                        <span class="page-dots">...</span>
                                    <% } %>
                                <% }
                                
                                // Sichtbare Seitenzahlen
                                for (int i = startPage; i <= endPage; i++) { %>
                                    <% if (i == currentPage) { %>
                                        <span class="page-number active"><%= i %></span>
                                    <% } else { %>
                                        <a href="verlauf.jsp?page=<%= i %>" class="page-number"><%= i %></a>
                                    <% } %>
                                <% }
                                
                                // Letzte Seite falls nicht sichtbar
                                if (endPage < totalPages) { %>
                                    <% if (endPage < totalPages - 1) { %>
                                        <span class="page-dots">...</span>
                                    <% } %>
                                    <a href="verlauf.jsp?page=<%= totalPages %>" class="page-number"><%= totalPages %></a>
                                <% } %>
                            </div>
                            
                            <!-- Nächste Seite -->
                            <% if (currentPage < totalPages) { %>
                                <a href="verlauf.jsp?page=<%= currentPage + 1 %>" class="btn btn-auswahl">Nächste →</a>
                            <% } else { %>
								<a href="verlauf.jsp?page=<%= currentPage + 1 %>" class="btn btn-auswahl" disabled >Nächste →</a>
							<% } %>
                        </div>
                    </div>
                    <% } %>
        <div class="navigation">
				<a href="verlauf.jsp" class="btn btn-auswahl active">Verlauf</a>
				<a href="profil.jsp" class="btn btn-auswahl">Profil</a>
				<% if(user.isAdmin()) { %>
                        <a href="admin_item.jsp" class="btn btn-auswahl admin-nav">Artikel</a>
                        <a href="admin_user.jsp" class="btn btn-auswahl admin-nav">Benutzer und Buchungen</a>
                    <% } %>
			</div>
	</div> 

    <script src="js/script.js"></script>
</body>
</html>